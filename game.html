<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ケバブケースゲーム</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'メイリオ', 'Meiryo', 'Hiragino Kaku Gothic ProN', sans-serif;
      overflow: hidden;
    }
    .word {
      position: absolute;
      font-size: 2.5rem; /* デフォルトはPC用 */
      font-weight: bold;
      user-select: none;
    }

    /* スマホ用（画面幅 640px 以下） */
    @media screen and (max-width: 640px) {
      .word {
        font-size: 1.5rem; /* 小さめに変更 */
      }
    }
    #skewer {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      max-width: 150px;
      max-height: 150px;
      object-fit: contain;
    }
  </style>
</head>
<body class="relative h-screen bg-gray-100 bg-[url('image/target_cut.png')] bg-center bg-cover">

  <!-- ヘッダー -->
  <header class="bg-amber-300/80 w-full shadow-md p-1 sticky top-0">
    <h1 class="text-center text-lg m-2">
      ゲーム：落ちてくる言葉に串をさしてケバブケース作れ！
    </h1>
  </header>

  <!-- メインコンテンツ -->
  <main id="gameArea" class="relative w-full" style="height: calc(100vh - 60px - 60px);">
    <p class="text-center text-lg">画面をリサイズしたら、再読み込みしてね</p>
    <!-- 串 -->
    <img id="skewer" src="image/skewer.png" alt="skewer">
    <!-- ボタン -->
    <div class="flex flex-col items-center justify-center min-h-[calc(100vh-100px)] w-full px-4 sm:px-8 lg:px-16">
      <button id="backButton" class="fixed bottom-[70px] left-5 px-4 py-2 bg-blue-500 text-white rounded" onclick="location.href='index.html'">ホームへ</button>
      <button id="backButton" class="fixed bottom-[70px] center-5 px-4 py-2 bg-blue-500 text-white rounded" onclick="location.href='glossary.html'">用語解説へ</button>
      <button id="moveButton" class="fixed bottom-[70px] right-5 px-4 py-2 bg-red-500 text-white rounded">串を刺す</button>
    </div>
    </main>

  <!-- フッター -->
  <footer class="bg-amber-300/80 w-full shadow-inner p-1 fixed bottom-0">
    <p class="text-center m-2">@NOA</p>
  </footer>

  <script>
    const words = ["apple ringo", "banana.test", "sakuraCherry", "date", "fig", "grape"];
    const wordElements = [];
    const results = [];

    const gameArea = document.getElementById("gameArea");
    const skewer = document.getElementById("skewer");
    let skewerLeft = 0;
    let flying = false;

    // ---------------------------
    // 串の初期位置設定（右端がウィンドウ右端に接触）
    // ---------------------------
    function setSkewerInitialPosition() {
      // 画像ロード済みで width が取得できる場合
      const skewerWidth = skewer.offsetWidth || 150; // fallback
      skewerLeft = window.innerWidth - skewerWidth;
      skewer.style.left = skewerLeft + "px";
      skewer.style.display = "block";
    }

    setSkewerInitialPosition();

    // ---------------------------
    // 単語生成
    // ---------------------------
    function createWord() {
    const word = document.createElement("div");
    word.classList.add("word");
    word.textContent = words[Math.floor(Math.random() * words.length)];
    gameArea.appendChild(word);

    // 単語の幅を取得
    const wordWidth = word.offsetWidth;

    // 単語の左端を決める範囲
    const minLeft = 10; // 左端マージン
    const maxLeft = skewerLeft - wordWidth; // 右端を串左端より左にする
    word.style.left = minLeft + Math.random() * (maxLeft - minLeft) + "px";

    // 上から落下
    word.style.top = "0px";
    word.dataset.speed = 0.5 + Math.random() * 1.5;

    wordElements.push(word);
  }

    // ---------------------------
    // 衝突判定
    // ---------------------------
    function hitCheckSkewer(skewerRect, wordRect) {
      const tolerance = 5;
      const skewerLeftX = skewerRect.left;
      const skewerRightX = skewerRect.right;
      const skewerCenterY = skewerRect.top + skewerRect.height / 2;

      const horizontalHit = (skewerLeftX <= wordRect.right + tolerance) &&
                            (skewerRightX >= wordRect.right - tolerance);
      const verticalHit = (skewerCenterY >= wordRect.top) &&
                          (skewerCenterY <= wordRect.bottom);
      return horizontalHit && verticalHit;
    }

    // ---------------------------
    // 単語落下＆衝突判定
    // ---------------------------
    function updateWords() {
      wordElements.forEach((word, index) => {
        const speed = parseFloat(word.dataset.speed);
        word.style.top = parseFloat(word.style.top) + speed + "px";

        const wordRect = word.getBoundingClientRect();
        const skewerRect = skewer.getBoundingClientRect();

        if (hitCheckSkewer(skewerRect, wordRect)) {
          const wordText = word.textContent || "";
          const skewerCenterY = skewerRect.top + skewerRect.height / 2;
          const hitPercent = ((skewerCenterY - wordRect.top) / wordRect.height) * 100;
          const clampedHitPercent = Math.min(Math.max(hitPercent, 0), 100).toFixed(1);

          results.push({ word: wordText, hitPercent: clampedHitPercent });
          console.log("衝突しました:", wordText, clampedHitPercent);

          word.remove();
          wordElements.splice(index, 1);

          setTimeout(() => {
            window.location.href = `result.html?word=${encodeURIComponent(wordText)}&hitPercent=${clampedHitPercent}`;
          }, 100);
        }

        if (parseFloat(word.style.top) > window.innerHeight) {
          word.remove();
          wordElements.splice(index, 1);
        }
      });
    }

    // ---------------------------
    // 串移動
    // ---------------------------
    document.getElementById("moveButton").addEventListener("click", () => {
      if (flying) return;
      flying = true;
      const speed = 40;

      function fly() {
        skewerLeft -= speed;
        if (skewerLeft < 0) skewerLeft = 0; // 左端で止める
        skewer.style.left = skewerLeft + "px";

        if (skewerLeft > 0) {
          requestAnimationFrame(fly);
        } else {
          // 左端に完全到達したら消して再出現
          skewer.style.display = "none";
          setTimeout(() => {
            setSkewerInitialPosition(); // 右端に接触する位置から再スタート
            flying = false;
          }, 300);
        }
      }

      requestAnimationFrame(fly);
    });

    // ---------------------------
    // ウィンドウリサイズ時
    // ---------------------------
    window.addEventListener('resize', () => {
      if (!flying) {
        setSkewerInitialPosition();
      }
    });

    // ---------------------------
    // ゲームループ
    // ---------------------------
    setInterval(() => {
      if (Math.random() < 0.03) createWord();
      updateWords();
    }, 16);

  </script>
</body>